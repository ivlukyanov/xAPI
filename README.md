# Библиотека xAPI
**Набор скриптов**, предназначенных для создания прослойки между несколькими сайтами, использующие общую базу своих пользователей.

**К примеру,** в рамках единого комплекса услуг существуют два сайта, которые предоставляют пользователям функции авторизации, восстановления пароля и чтения/обновления персональных данных. При этом данные пользователей должны быть одинаковыми, и нет смысла дублировать их в базе каждого сайта.

## Данная библиотека может:
1. Логгировать все запросы API-функций
1. Выводить понятные ошибки на всех уровнях их возникновения 
1. Авторизовывать пользователя по логину и паролю
1. Восстанавливать пароль с подтверждением по временному ключу
1. Изменять email пользователя с подтверждением по временному ключу
1. Удалять пользователя из системы с подтверждением по временному ключу
1. Регистрировать партнеров по одноуровневой реферральной системе, а также учитывать партнерские начисления за оплату услуг от реферралов

## Требования к системе сайтов с прослойкой xAPI:
1. Каждый сайт (хост) должен иметь поддержку минимум PHP 5.3
1. В корень каждого сайта положить папку `xapi` и настроить их синхронизацию со своим репозиторием
1. В загрузчике каждого сайта объявить функцию автоподгрузки 
`xAPI_autoload($class_name)` (ниже пример)
1. Создать общую базу данных с таблицей пользователей и нужными полями
1. Для удобства отладки создать отдельный хост типа main.yourdomain.com и положить в корень следующие файлы и папки:
    * `xapi` (настроить синхронизацию)
    * `index.php`. Это главный узел xAPI, принимающий большую часть вызовов от сайтов.
1. Не забывать синхронизировать все папки `xapi` на каждом сайте при внесении изменений в классы.

## Пример объявления библиотеки xAPI в коде сайта:
Данная функция объявляется и следом вызывается в инициализирующем скрипте сайта (конфиг, индексный файл и т.п. - что удобнее):

```php
<?
/*
 * Created by Ivan Lukyanov.
 * Функция автозагрузки классов библиотеки xAPI.
 */
function xAPI_autoload($class_name) {
	// название класса xAPI обязательно должно начинаться с 'xAPI_'
	if (substr($class_name, 0, 5) === 'xAPI_') {
		$module_name = strtolower(substr($class_name, 5)); // получаем название директории модуля из названия класса

		// Необходимо правильно указать полный путь к корневой папке узла xAPI!
		// Учтите, что при вызове xAPI каким-либо образом из шелла (командной строки - CLI), переменная $_SERVER['DOCUMENT_ROOT'] пустая
		defined('_XAPI_ROOT') OR define('_XAPI_ROOT', $_SERVER['DOCUMENT_ROOT'] . DIRECTORY_SEPARATOR . 'xapi' . DIRECTORY_SEPARATOR); // корневая папка узла xAPI

		$file_name = _XAPI_ROOT . $module_name . DIRECTORY_SEPARATOR . 'bootstrap.php'; // предполагаемый путь к файлу подгрузки класса модуля

		if (!file_exists($file_name)) { // если файл не существует, выдадим ошибку
			trigger_error('PHP-file for autoload class ' . $class_name . ' not found!', E_USER_ERROR);
		}
		require_once $file_name; // в bootstrap.php объявляются константы модуля и подгружается сам файл класса
	}
}

// Устанавливаем объявленную функцию как обработчик автозагрузки для классов xAPI
spl_autoload_register('xAPI_autoload');
```
